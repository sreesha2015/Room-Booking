<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Room Allocation — Supabase (Existing Rooms Schema)</title>
  <style>
    :root { --bg:#0b1220; --card:#111a2b; --muted:#8aa0c6; --text:#e9eefc; --accent:#4da3ff; --accent2:#6dd3ff; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#0b1220,#0b1220 220px,#0e1630);color:var(--text)}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    h1{font-size:26px;margin:0 0 8px}
    .tabs{display:flex;gap:8px;margin:16px 0;flex-wrap:wrap}
    .tab{padding:10px 14px;border-radius:999px;background:#0f1830;border:1px solid #1a2746;cursor:pointer;color:#cfe3ff}
    .tab.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#0b1220;font-weight:700}
    .grid{display:grid;gap:12px}
    .two{grid-template-columns:1fr 1fr}
    .three{grid-template-columns:repeat(3,1fr)}
    .card{background:var(--card);border:1px solid #1a2746;border-radius:16px;padding:16px;box-shadow:0 2px 12px rgba(0,0,0,0.25)}
    label{display:block;font-size:12px;color:#a9bde4;margin-bottom:6px}
    input,select{width:100%;padding:10px;border-radius:10px;background:#0e1730;border:1px solid #203056;color:#eaf2ff}
    button{padding:10px 14px;border-radius:12px;border:1px solid #29477a;background:linear-gradient(90deg,#1a335d,#1d3f79);color:#eaf2ff;cursor:pointer}
    button.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#0a1222;border:none}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #23365f;text-align:left;font-size:14px}
    .pill{padding:4px 8px;border-radius:999px;background:#13234a;border:1px solid #24407b;font-size:12px}
    .ok{background:#0e3a2f;border-color:#1b6f5a}
    .warn{background:#402313;border-color:#8a3a24}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .spacer{height:8px}
    .hint{color:#9fb7e6;font-size:12px}
    .right{float:right}
  </style>
</head>
<body>
  <!-- load Supabase client (defines window.sb) -->
  <script type="module" src="./supabaseClient.js"></script>

  <div class="wrap">
    <h1>Room Allocation</h1>
    <div class="hint">Admin enters pre-booked slots. Users allocate rooms. Using existing rooms schema: (id, block, name, ranges, capacity, active).</div>

    <div class="tabs">
      <button class="tab active" id="tab-admin">Admin</button>
      <button class="tab" id="tab-allocate">Allocate</button>
      <button class="tab" id="tab-allocated">Allocated</button>
    </div>

    <!-- Admin Card -->
    <section id="admin" class="card">
      <h2>Admin — Add Pre‑Booked Slot</h2>
      <div class="grid three">
        <div>
          <label>Booking ID</label>
          <input id="a-booking" placeholder="e.g., BKG-2025-001" />
        </div>
        <div>
          <label>Block</label>
          <input id="a-block" placeholder="e.g., Block A" />
        </div>
        <div>
          <label>Room Name/No</label>
          <input id="a-room" placeholder="e.g., 105 or Deluxe-1" />
        </div>
      </div>
      <div class="grid two" style="margin-top:10px">
        <div>
          <label>Start Date</label>
          <input type="date" id="a-start" />
        </div>
        <div>
          <label>End Date</label>
          <input type="date" id="a-end" />
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="btn-add" class="primary">Add Slot</button>
        <div id="admin-msg" class="hint"></div>
      </div>

      <div class="spacer"></div>
      <h3>All Slots</h3>
      <div class="row">
        <input id="f-booking-admin" placeholder="Filter by Booking ID (optional)" style="max-width:260px" />
        <button id="btn-reload-admin">Reload</button>
      </div>
      <div class="spacer"></div>
      <table>
        <thead>
          <tr>
            <th>Booking ID</th>
            <th>Block</th>
            <th>Room</th>
            <th>Start</th>
            <th>End</th>
            <th>Status</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="admin-rows"></tbody>
      </table>
    </section>

    <!-- Allocate Card -->
    <section id="allocate" class="card" style="display:none">
      <h2>Allocate — Assign Room to Guest</h2>
      <div class="grid three">
        <div>
          <label>Booking ID (filter)</label>
          <input id="u-booking" placeholder="e.g., BKG-2025-001" />
        </div>
        <div>
          <label>Block (filter)</label>
          <input id="u-block" placeholder="e.g., Block A" />
        </div>
        <div>
          <label>Date Needed</label>
          <input type="date" id="u-date" />
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="btn-find" class="primary">Find Available</button>
        <div id="user-msg" class="hint"></div>
      </div>

      <div class="spacer"></div>
      <table>
        <thead>
          <tr>
            <th>Booking ID</th>
            <th>Block</th>
            <th>Room</th>
            <th>Start–End</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="user-rows"></tbody>
      </table>
    </section>

    <!-- Allocated Card -->
    <section id="allocated" class="card" style="display:none">
      <h2>Allocated — View & Cancel</h2>
      <div class="grid three">
        <div>
          <label>Booking ID (filter)</label>
          <input id="al-booking" placeholder="e.g., BKG-2025-001" />
        </div>
        <div>
          <label>Block (filter)</label>
          <input id="al-block" placeholder="e.g., Block A" />
        </div>
        <div>
          <label>Date (within start–end)</label>
          <input type="date" id="al-date" />
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="btn-load-allocated" class="primary">Load Allocations</button>
        <div id="al-msg" class="hint"></div>
      </div>

      <div class="spacer"></div>
      <table>
        <thead>
          <tr>
            <th>Booking ID</th>
            <th>Block</th>
            <th>Room</th>
            <th>Guest</th>
            <th>Mobile</th>
            <th>Start–End</th>
            <th>Allocated At</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="allocated-rows"></tbody>
      </table>
    </section>
  </div>

  <script type="module">
    // Wait for Supabase client
    const waitForSB = () => new Promise((resolve) => {
      if (window.sb) return resolve(window.sb);
      const i = setInterval(() => { if (window.sb) { clearInterval(i); resolve(window.sb); } }, 50);
    });

    const sb = await waitForSB();

    // Tab switching
    const tabs = {
      admin: { tab: document.getElementById('tab-admin'), section: document.getElementById('admin') },
      allocate: { tab: document.getElementById('tab-allocate'), section: document.getElementById('allocate') },
      allocated: { tab: document.getElementById('tab-allocated'), section: document.getElementById('allocated') },
    };

    function show(which) {
      for (const k in tabs) {
        const active = k === which;
        tabs[k].tab.classList.toggle('active', active);
        tabs[k].section.style.display = active ? '' : 'none';
      }
      if (which === 'admin') loadAdminRows();
      if (which === 'allocated') loadAllocatedRows();
    }

    tabs.admin.tab.onclick = () => show('admin');
    tabs.allocate.tab.onclick = () => show('allocate');
    tabs.allocated.tab.onclick = () => show('allocated');

    // Admin: Add Slot
    const aBooking = document.getElementById('a-booking');
    const aBlock   = document.getElementById('a-block');
    const aRoom    = document.getElementById('a-room');
    const aStart   = document.getElementById('a-start');
    const aEnd     = document.getElementById('a-end');
    const aMsg     = document.getElementById('admin-msg');
    const btnAdd   = document.getElementById('btn-add');

    btnAdd.onclick = async () => {
      aMsg.textContent = '';
      const booking_id = aBooking.value.trim();
      const block = aBlock.value.trim();
      const name  = aRoom.value.trim();
      const start_date = aStart.value;
      const end_date   = aEnd.value;
      if (!booking_id || !block || !name || !start_date || !end_date) {
        aMsg.textContent = 'Fill all fields.'; return;
      }
      if (end_date < start_date) { aMsg.textContent = 'End date cannot be before start date.'; return; }

      const { data: roomUpsert, error: roomErr } = await sb
        .from('rooms')
        .upsert({ block, name }, { onConflict: 'block,name' })
        .select('id')
        .single();
      if (roomErr) { aMsg.textContent = 'Room upsert failed: ' + roomErr.message; return; }

      const { error: avErr } = await sb.from('room_availability').insert({
        room_id: roomUpsert.id, booking_id, start_date, end_date
      });
      if (avErr) { aMsg.textContent = 'Add slot failed: ' + avErr.message; return; }

      aMsg.textContent = 'Slot added.';
      aRoom.value = ''; aStart.value = ''; aEnd.value = '';
      loadAdminRows();
    };

    // Admin: List all slots with status
    const adminRows = document.getElementById('admin-rows');
    const fBookingAdmin = document.getElementById('f-booking-admin');
    document.getElementById('btn-reload-admin').onclick = loadAdminRows;

    async function loadAdminRows() {
      adminRows.innerHTML = '<tr><td colspan="7">Loading…</td></tr>';
      let q = sb.from('room_availability')
        .select('id, booking_id, start_date, end_date, rooms:room_id(id, block, name), allocations(id)')
        .order('start_date', { ascending: true });

      const f = fBookingAdmin.value.trim();
      if (f) q = q.eq('booking_id', f);

      const { data, error } = await q;
      if (error) { adminRows.innerHTML = `<tr><td colspan="7">${error.message}</td></tr>`; return; }

      adminRows.innerHTML = '';
      (data || []).forEach(r => {
        const allocated = r.allocations && r.allocations.length > 0;
        const tr = document.createElement('tr');
        const roomName = r.rooms?.name ?? '?';
        const block = r.rooms?.block ?? '?';
        tr.innerHTML = `
          <td>${r.booking_id}</td>
          <td>${block}</td>
          <td>${roomName}</td>
          <td>${r.start_date}</td>
          <td>${r.end_date}</td>
          <td><span class="pill ${allocated ? 'warn' : 'ok'}">${allocated ? 'Allocated' : 'Available'}</span></td>
          <td><button data-id="${r.id}" class="del">Delete</button></td>`;
        adminRows.appendChild(tr);
      });

      adminRows.querySelectorAll('button.del').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.getAttribute('data-id');
          if (!confirm('Delete this slot? (Any allocation will also be removed)')) return;
          const { error } = await sb.from('room_availability').delete().eq('id', id);
          if (error) alert('Delete failed: ' + error.message);
          else loadAdminRows();
        };
      });
    }

    // Allocate: find & allocate
    const uBooking = document.getElementById('u-booking');
    const uBlock   = document.getElementById('u-block');
    const uDate    = document.getElementById('u-date');
    const btnFind  = document.getElementById('btn-find');
    const userRows = document.getElementById('user-rows');
    const uMsg     = document.getElementById('user-msg');

    btnFind.onclick = async () => {
      uMsg.textContent = '';
      const day = uDate.value;
      if (!day) { uMsg.textContent = 'Select a date to search.'; return; }

      let q = sb.from('room_availability')
        .select('id, booking_id, start_date, end_date, rooms:room_id(id, block, name), allocations(id)')
        .lte('start_date', day)
        .gte('end_date', day)
        .order('start_date', { ascending: true });

      const bkg = uBooking.value.trim();
      const blk = uBlock.value.trim();
      if (bkg) q = q.eq('booking_id', bkg);
      if (blk) q = q.eq('rooms.block', blk);

      const { data, error } = await q;
      if (error) { userRows.innerHTML = `<tr><td colspan="5">${error.message}</td></tr>`; return; }

      const available = (data || []).filter(r => !r.allocations || r.allocations.length === 0);

      if (available.length === 0) {
        userRows.innerHTML = '<tr><td colspan="5">No available rooms for the chosen filters/date.</td></tr>';
        return;
      }

      userRows.innerHTML = '';
      available.forEach(r => {
        const tr = document.createElement('tr');
        const roomName = r.rooms?.name ?? '?';
        const block = r.rooms?.block ?? '?';
        tr.innerHTML = `
          <td>${r.booking_id}</td>
          <td>${block}</td>
          <td>${roomName}</td>
          <td>${r.start_date} → ${r.end_date}</td>
          <td>
            <div class="row">
              <input placeholder="Guest name" data-gn="${r.id}" />
              <input placeholder="Mobile" data-mb="${r.id}" />
              <button class="primary" data-alloc="${r.id}">Allocate</button>
            </div>
          </td>`;
        userRows.appendChild(tr);
      });

      userRows.querySelectorAll('button[data-alloc]').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.getAttribute('data-alloc');
          const g = userRows.querySelector(`input[data-gn="${id}"]`).value.trim();
          const m = userRows.querySelector(`input[data-mb="${id}"]`).value.trim();
          if (!g || !m) { alert('Enter guest name and mobile'); return; }

          const { error } = await sb.from('allocations').insert({ availability_id: id, guest_name: g, mobile: m });
          if (error) {
            alert('Allocation failed: ' + error.message);
          } else {
            alert('Allocated!');
            btnFind.click();
          }
        };
      });
    };

    // Allocated: view & cancel
    const alBooking = document.getElementById('al-booking');
    const alBlock   = document.getElementById('al-block');
    const alDate    = document.getElementById('al-date');
    const alMsg     = document.getElementById('al-msg');
    const btnLoadAllocated = document.getElementById('btn-load-allocated');
    const allocatedRows = document.getElementById('allocated-rows');

    btnLoadAllocated.onclick = loadAllocatedRows;

    async function loadAllocatedRows() {
      allocatedRows.innerHTML = '<tr><td colspan="8">Loading…</td></tr>';
      const { data, error } = await sb.from('allocations')
        .select('id, guest_name, mobile, allocated_at, room_availability:availability_id(id, booking_id, start_date, end_date, rooms:room_id(id, block, name))')
        .order('allocated_at', { ascending: false });

      if (error) { allocatedRows.innerHTML = `<tr><td colspan="8">${error.message}</td></tr>`; return; }

      const bkg = alBooking.value.trim().toLowerCase();
      const blk = alBlock.value.trim().toLowerCase();
      const day = alDate.value;

      let rows = (data || []);
      // Client-side filters (safe & simple)
      if (bkg) rows = rows.filter(x => (x.room_availability?.booking_id || '').toLowerCase() === bkg);
      if (blk) rows = rows.filter(x => (x.room_availability?.rooms?.block || '').toLowerCase() === blk);
      if (day) rows = rows.filter(x => (x.room_availability?.start_date || '') <= day && (x.room_availability?.end_date || '') >= day);

      if (rows.length === 0) {
        allocatedRows.innerHTML = '<tr><td colspan="8">No allocations match the filters.</td></tr>';
        return;
      }

      allocatedRows.innerHTML = '';
      rows.forEach(x => {
        const r = x.room_availability || {};
        const room = r.rooms || {};
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.booking_id || '-'}</td>
          <td>${room.block || '-'}</td>
          <td>${room.name || '-'}</td>
          <td>${x.guest_name}</td>
          <td>${x.mobile}</td>
          <td>${r.start_date} → ${r.end_date}</td>
          <td>${new Date(x.allocated_at).toLocaleString()}</td>
          <td><button class="del" data-alloc-id="${x.id}">Cancel</button></td>`;
        allocatedRows.appendChild(tr);
      });

      // Cancel handler
      allocatedRows.querySelectorAll('button.del').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.getAttribute('data-alloc-id');
          if (!confirm('Cancel this allocation?')) return;
          const { error } = await sb.from('allocations').delete().eq('id', id);
          if (error) alert('Cancel failed: ' + error.message);
          else {
            alert('Allocation cancelled.');
            loadAllocatedRows();
          }
        };
      });
    }

    // Initial load
    show('admin');
  </script>
</body>
</html>
